<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Management Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, select { margin: 5px 0; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    #admin-forms { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Task Management Dashboard</h1>

  <!-- Login Form -->
  <div id="login-div">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" /><br>
    <input type="password" id="password" placeholder="Password" /><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-div" style="display:none;">
    <button onclick="logout()">Logout</button>
    <h2>Welcome, <span id="user-email"></span>!</h2>
    <h3>My Tasks</h3>
    <table id="tasks-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Status</th>
          <th>Created At</th>
          <th>Updated At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Admin-only forms -->
    <div id="admin-forms" style="display:none;">
      <h3>Create User</h3>
      <form id="userForm">
        <input type="email" id="new-email" placeholder="Email" required>
        <input type="password" id="new-password" placeholder="Password" required>
        <select id="new-role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button type="button" onclick="createUser()">Create User</button>
      </form>

      <h3>Create Task</h3>
      <form id="taskForm">
        <input type="text" id="new-title" placeholder="Title" required>
        <input type="text" id="new-description" placeholder="Description">
        <select id="new-status">
          <option value="未着手">未着手</option>
          <option value="進行中">進行中</option>
          <option value="完了">完了</option>
        </select>
        <input type="text" id="new-assigned-to" placeholder="Assign to User ID (optional)">
        <button type="button" onclick="createTask()">Create Task</button>
      </form>
    </div>
  </div>

  <script>
    let token = "";
    let currentUser = null;

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const res = await fetch("http://localhost:8000/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username: email, password: password })
      });

      if (res.ok) {
        const data = await res.json();
        token = data.access_token;

        // Hide login form, show dashboard
        document.getElementById("login-div").style.display = "none";
        document.getElementById("dashboard-div").style.display = "block";
        document.getElementById("user-email").innerText = email;

        // Load tasks and user info
        await loadCurrentUser();
        loadTasks();
      } else {
        alert("Login failed");
      }
    }

    async function loadCurrentUser() {
      // Fetch user info from /users/me endpoint
      const res = await fetch("http://localhost:8000/api/users/me", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        alert("Failed to load user info");
        return;
      }

      currentUser = await res.json();  // currentUser is already the object

      if (currentUser.role === "admin") {
        document.getElementById("admin-forms").style.display = "block";
      } else {
        document.getElementById("admin-forms").style.display = "none";
      }
    }


    async function loadTasks() {
      const res = await fetch("http://localhost:8000/api/tasks/", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        alert("Failed to load tasks");
        return;
      }

      const tasks = await res.json();
      const tbody = document.querySelector("#tasks-table tbody");
      tbody.innerHTML = "";

      tasks.forEach(task => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${task.title}</td>
          <td>${task.description || ""}</td>
          <td>${task.status}</td>
          <td>${task.created_at}</td>
          <td>${task.updated_at}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function createUser() {
      const email = document.getElementById("new-email").value;
      const password = document.getElementById("new-password").value;
      const role = document.getElementById("new-role").value;

      const res = await fetch("http://localhost:8000/api/users/", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ email, password, role })
      });

      if (res.ok) {
        alert("User created!");
        document.getElementById("new-email").value = "";
        document.getElementById("new-password").value = "";
      } else {
        const data = await res.json();
        alert("Error: " + JSON.stringify(data.detail));
      }
    }

    async function createTask() {
      const title = document.getElementById("new-title").value;
      const description = document.getElementById("new-description").value;
      const status = document.getElementById("new-status").value;
      const assigned_to = document.getElementById("new-assigned-to").value || null;

      const res = await fetch("http://localhost:8000/api/tasks/", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ title, description, status, assigned_to })
      });

      if (res.ok) {
        alert("Task created!");
        document.getElementById("new-title").value = "";
        document.getElementById("new-description").value = "";
        document.getElementById("new-assigned-to").value = "";
        loadTasks();
      } else {
        const data = await res.json();
        alert("Error: " + JSON.stringify(data.detail));
      }
    }

    function logout() {
      token = "";
      currentUser = null;
      document.getElementById("dashboard-div").style.display = "none";
      document.getElementById("login-div").style.display = "block";
    }
  </script>
</body>
</html>
